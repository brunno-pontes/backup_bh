{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-vivo mb-0">
        <i class="fas fa-users me-2"></i>Lista de Anotações
    </h3>
    <span class="badge bg-primary">{{ requests|length }} pendentes</span>
</div>

<!-- Resumo dos subordinados -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">
            <i class="fas fa-user-friends me-2"></i>Minha equipe
        </h5>
        <div class="d-flex flex-wrap gap-2">
            {% for sub in current_user.subordinados %}
            <span class="badge bg-secondary">
                <i class="fas fa-user me-1"></i>{{ sub.username }}
            </span>
            {% else %}
            <span class="text-muted">Nenhum subordinado encontrado</span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Filtro por tipo -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex align-items-center flex-wrap">
            <div class="me-3 mb-2 mb-md-0">
                <label for="tipo" class="form-label fw-bold mb-0">Filtrar por tipo:</label>
            </div>
            <div class="me-2 mb-2 mb-md-0">
                <select name="tipo" id="tipo" class="form-select">
                    <option value="">Todos os tipos</option>
                    <option value="BH" {% if tipo_selecionado=='BH' %}selected{% endif %}>Banco de Horas</option>
                    <option value="Ferias" {% if tipo_selecionado=='Ferias' %}selected{% endif %}>Férias</option>
                    <option value="Dayoff" {% if tipo_selecionado=='Dayoff' %}selected{% endif %}>Dayoff</option>
                    <option value="Maternidade" {% if tipo_selecionado=='Maternidade' %}selected{% endif %}>Licença
                        Maternidade</option>
                    <option value="Paternidade" {% if tipo_selecionado=='Paternidade' %}selected{% endif %}>Licença
                        Paternidade</option>
                </select>
            </div>
            <div class="mb-2 mb-md-0">
                <button type="submit" class="btn btn-vivo">
                    <i class="fas fa-filter me-1"></i>Filtrar
                </button>
                <a href="{{ url_for('gestor.lista_solicitacoes') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tabela de anotações -->
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between mb-3">
            <h5 class="card-title me-2">Lista de Anotações</h5>
            <a href="{{ url_for('gestor.exportar_solicitacoes') }}" class="btn btn-outline-primary">
                <i class="fas fa-download me-1"></i>Exportar CSV
            </a>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-vivo text-white">
                    <tr>
                        <th>Usuário</th>
                        <th>Tipo</th>
                        <th>Período</th>
                        <th>Dias</th>
                        <th>Status</th>
                        <th>Data de Solicitação</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in requests %}
                    <tr>
                        <td>
                            <i class="fas fa-user me-1"></i>{{ r.user.username }}
                        </td>
                        <td>
                            {% if r.type == 'Ferias' %}
                            <span class="badge bg-warning">Férias</span>
                            {% elif r.type == 'BH' %}
                            <span class="badge bg-info">Banco de Horas</span>
                            {% elif r.type == 'Dayoff' %}
                            <span class="badge bg-success">Dayoff</span>
                            {% elif r.type == 'Maternidade' %}
                            <span class="badge bg-pink">Maternidade</span>
                            {% elif r.type == 'Paternidade' %}
                            <span class="badge bg-blue">Paternidade</span>
                            {% endif %}
                        </td>
                        <td>{{ r.start_date.strftime("%d/%m/%Y") }} - {{ r.end_date.strftime("%d/%m/%Y") }}</td>
                        <td>{{ (r.end_date - r.start_date).days + 1 }} dias</td>
                        <td>
                            {% if r.status == 'Pendente' %}
                            <span class="badge bg-warning">Pendente</span>
                            {% elif r.status == 'Aprovado' %} <!-- CORRIGIDO: Aprovado em vez de A provado -->
                            <span class="badge bg-success">Aprovado</span>
                            {% elif r.status == 'Rejeitado' %}
                            <span class="badge bg-danger">Rejeitado</span>
                            {% endif %}
                        </td>
                        <td>{{ r.start_date.strftime("%d/%m/%Y") }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <!-- Verificar se há conflito de datas antes de aprovar -->
                                <a href="{{ url_for('gestor.aprovar_reprovar', request_id=r.id, acao='aprovar') }}"
                                    class="btn btn-success btn-sm" title="Aprovar">
                                    <i class="fas fa-check"></i>
                                </a>
                                <a href="{{ url_for('gestor.aprovar_reprovar', request_id=r.id, acao='reprovar') }}"
                                    class="btn btn-danger btn-sm" title="Reprovar">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">
                            <i class="fas fa-inbox fa-2x mb-2 d-block text-muted"></i>
                            Nenhuma anotação pendente encontrada.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .text-vivo {
        color: #660099;
    }

    .btn-vivo {
        background-color: #660099;
        color: #fff;
    }

    .btn-vivo:hover {
        background-color: #4d0073;
        color: #fff;
    }

    .table-vivo {
        background-color: #660099;
    }

    .bg-pink {
        background-color: #e83e8c !important;
    }

    .bg-blue {
        background-color: #0d6efd !important;
    }
</style>
{% endblock %}